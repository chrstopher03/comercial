<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VogueCrest - Escáner QR</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
    }
    video, canvas {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    #producto-info {
      background-color: #111;
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
      display: none;
    }
    #producto-info img {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 15px;
      height: 250px;
      object-fit: cover;
    }
    h2 {
      color: #f8c630;
    }
    .precio {
      font-weight: 700;
      font-size: 1.2rem;
      color: #f8c630;
      margin-top: 10px;
    }
    .material {
      font-size: 0.95rem;
      color: #ccc;
      margin-bottom: 10px;
    }
    #mensaje {
      font-style: italic;
      color: #bbb;
      margin-bottom: 20px;
    }
    .boton {
      background: #f8c630;
      border: none;
      padding: 10px 20px;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      color: #000;
      margin: 10px 5px;
    }
    .loader {
      border: 4px solid #333;
      border-top: 4px solid #f8c630;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    input[type="file"] {
      display: none;
    }
    label[for="subirQR"] {
      display: inline-block;
      background: #f8c630;
      color: #000;
      font-weight: 700;
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      margin: 10px 5px;
    }
  </style>
</head>
<body>

  <h1>Escáner QR VogueCrest</h1>
  <p id="mensaje">Cargando cámara...</p>
  <div id="loader" class="loader"></div>

  <div id="video-container"></div>

  <div id="producto-info"></div>

  <button id="reiniciar" class="boton" style="display:none;">Escanear otro</button>
  <button id="cambiarCamara" class="boton" style="display:none;">Cambiar cámara</button>

  <input type="file" accept="image/*" id="subirQR" />
  <label for="subirQR">Escanear desde foto</label>

  <!-- Librería QR -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script>
    const productos = [
      {
        id: 1,
        nombre: "Playera Oversized Blanco",
        descripcion: "Playera amplia con diseño moderno y cómoda para el verano.",
        precio: 520,
        imagen: "1.jpeg",
        material: "100% algodón orgánico, teñido con tintes naturales."
      },
      {
        id: 2,
        nombre: "Playera Cebra",
        descripcion: "Playera con estampado de cebra, ideal para destacar en la multitud.",
        precio: 620,
        imagen: "descarga.jpg",
        material: "Tela suave con mezcla de algodón y poliéster reciclado."
      },
      {
        id: 3,
        nombre: "Playera Semi Oversized Negra",
        descripcion: "Playera semi oversized color negro, elegante y versátil.",
        precio: 570,
        imagen: "Semi Oversized Summer Rugby T-shirt_Black.jpg",
        material: "Algodón 100%, certificado GOTS, producido bajo estándares éticos."
      }
    ];

    let html5QrCode;
    let currentCameraId = null;
    let cameras = [];

    const videoContainer = document.getElementById("video-container");
    const mensaje = document.getElementById("mensaje");
    const loader = document.getElementById("loader");
    const productoInfo = document.getElementById("producto-info");
    const reiniciarBtn = document.getElementById("reiniciar");
    const cambiarCamaraBtn = document.getElementById("cambiarCamara");
    const subirQRInput = document.getElementById("subirQR");

    function extraerIdDeUrl(url) {
      try {
        const u = new URL(url, window.location.href);
        return parseInt(u.searchParams.get('id'));
      } catch {
        return null;
      }
    }

    function mostrarProducto(id) {
      const producto = productos.find(p => p.id === id);
      if (!producto) {
        productoInfo.innerHTML = "<p>Producto no encontrado.</p>";
      } else {
        productoInfo.innerHTML = `
          <img src="${producto.imagen}" alt="${producto.nombre}" />
          <h2>${producto.nombre}</h2>
          <p>${producto.descripcion}</p>
          <p class="material"><strong>Material:</strong> ${producto.material}</p>
          <p class="precio">Precio: $${producto.precio.toFixed(2)}</p>
        `;
      }
      productoInfo.style.display = "block";
      mensaje.style.display = "none";
      reiniciarBtn.style.display = "inline-block";
      cambiarCamaraBtn.style.display = "inline-block";
      loader.style.display = "none";
      html5QrCode.stop().catch(() => {});
    }

    function iniciarEscaner(cameraId) {
      mensaje.textContent = "Apunta la cámara al código QR de la prenda.";
      loader.style.display = "none";
      productoInfo.style.display = "none";
      reiniciarBtn.style.display = "none";

      html5QrCode = new Html5Qrcode("video-container");

      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          const id = extraerIdDeUrl(decodedText);
          if (id) mostrarProducto(id);
          else mensaje.textContent = "QR no válido.";
        },
        () => {} // errores ignorados
      );
    }

    function cargarCamaras() {
      Html5Qrcode.getCameras().then(devs => {
        if (devs.length === 0) {
          mensaje.textContent = "No se encontró cámara.";
          loader.style.display = "none";
          return;
        }
        cameras = devs;
        currentCameraId = cameras[0].id;
        iniciarEscaner(currentCameraId);
        cambiarCamaraBtn.style.display = cameras.length > 1 ? "inline-block" : "none";
      }).catch(err => {
        mensaje.textContent = "Error accediendo a la cámara: " + err;
        loader.style.display = "none";
      });
    }

    reiniciarBtn.onclick = () => {
      html5QrCode.clear().then(() => {
        iniciarEscaner(currentCameraId);
      });
    };

    cambiarCamaraBtn.onclick = () => {
      const index = cameras.findIndex(c => c.id === currentCameraId);
      const next = (index + 1) % cameras.length;
      currentCameraId = cameras[next].id;
      html5QrCode.clear().then(() => iniciarEscaner(currentCameraId));
    };

    subirQRInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        Html5Qrcode.getCameras(); // Evita errores con instancias viejas
        Html5Qrcode.scanFile(file, true)
          .then(decodedText => {
            const id = extraerIdDeUrl(decodedText);
            if (id) mostrarProducto(id);
            else mensaje.textContent = "Imagen escaneada, pero QR no válido.";
          })
          .catch(err => {
            mensaje.textContent = "No se pudo leer el QR de la imagen.";
          });
      };
      reader.readAsDataURL(file);
    });

    cargarCamaras();
  </script>
</body>
</html>
